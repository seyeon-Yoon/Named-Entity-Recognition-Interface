{% extends "base.html" %}

{% block content %}
<!-- Export Files Dashboard -->
<div id="export-dashboard">
    <div class="dashboard-header">
        <h2>Dashboard</h2>
        <div class="dashboard-actions">
            <a href="../collaborate" class="nav-button">ü§ù Collaborate</a>
            <button onclick="refreshExportList()">Refresh</button>
        </div>
    </div>
    
    <div class="workspace-filter">
        <label for="workspace-select">ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§:</label>
        <select id="workspace-select">
            <option value="">Ï†ÑÏ≤¥</option>
        </select>
    </div>
    
    <div id="file-list">
        <ul id="file-items"></ul>
    </div>
</div>

<!-- Export File Details Modal -->
<div id="file-details-modal" class="modal" style="display: none;">
    <div class="modal-content large">
        <div class="modal-header">
            <h3 id="file-name"></h3>
            <button onclick="hideFileDetailsModal()">&times;</button>
        </div>
        <div class="file-details">
            <div class="detail-section">
                <h4>File Information</h4>
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>Workspace:</label>
                        <span id="detail-workspace"></span>
                    </div>
                    <div class="detail-item">
                        <label>Export Date:</label>
                        <span id="detail-date"></span>
                    </div>
                    <div class="detail-item">
                        <label>File Size:</label>
                        <span id="detail-size"></span>
                    </div>
                    <div class="detail-item">
                        <label>Format:</label>
                        <span id="detail-format"></span>
                    </div>
                    <div class="detail-item">
                        <label>Records:</label>
                        <span id="detail-records"></span>
                    </div>
                </div>
            </div>
            <div class="detail-section">
                <h4>Actions</h4>
                <div class="file-actions">
                    <button onclick="downloadFile()" class="btn-primary">Download</button>
                    <button onclick="previewFile()" class="btn-secondary">Preview</button>
                    <button onclick="deleteFile()" class="btn-danger">Delete</button>
                </div>
            </div>
            <div class="detail-section" id="preview-section" style="display: none;">
                <h4>Preview</h4>
                <div id="file-preview" class="file-preview"></div>
            </div>
        </div>
    </div>
</div>
    


<!-- Create Project Modal -->
<div id="create-project-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Create New Project</h3>
        <form id="create-project-form">
            <input type="text" id="new-project-name" placeholder="Project Name" required>
            <textarea id="new-project-description" placeholder="Description (optional)"></textarea>
            <div class="modal-actions">
                <button type="button" onclick="hideCreateProjectModal()">Cancel</button>
                <button type="submit">Create</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadExportedFiles();
    setupFilters();
});

// Export file management
let currentFiles = [];
let filteredFiles = [];


async function loadExportedFiles() {
    try {
        const response = await fetch('/api/exports');
        const data = await response.json();
        currentFiles = data.files || [];
        filteredFiles = [...currentFiles];
        updateStats();
        populateWorkspaceFilter();
        renderFileList();
    } catch (error) {
        console.error('Error loading exported files:', error);
        showMessage('Error loading files', 'error');
    }
}

function updateStats() {
    // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏Îäî Ï†úÍ±∞Îê® (UI ÏöîÏÜå ÏÇ≠Ï†ú)
}

function populateWorkspaceFilter() {
    const workspaces = [...new Set(currentFiles.map(file => file.workspace))];
    const select = document.getElementById('workspace-select');
    select.innerHTML = '<option value="">Ï†ÑÏ≤¥</option>';
    workspaces.forEach(workspace => {
        const option = document.createElement('option');
        option.value = workspace;
        option.textContent = workspace;
        select.appendChild(option);
    });
}

function setupFilters() {
    document.getElementById('workspace-select').addEventListener('change', applyFilters);
}

function applyFilters() {
    const workspaceFilter = document.getElementById('workspace-select').value;
    
    filteredFiles = currentFiles.filter(file => {
        if (workspaceFilter && file.workspace !== workspaceFilter) return false;
        return true;
    });
    
    updateStats();
    renderFileList();
}

function renderFileList() {
    const container = document.getElementById('file-items');
    
    if (filteredFiles.length === 0) {
        container.innerHTML = '<li class="no-files">ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§</li>';
        return;
    }
    
    container.innerHTML = filteredFiles.map(file => 
        '<li class="file-item" onclick="showFileDetails(\'' + file.id + '\')">' +
            '<span class="file-name">' + file.name + '</span>' +
            '<span class="workspace-tag">' + file.workspace + '</span>' +
        '</li>'
    ).join('');
}

function showFileDetails(fileId) {
    const file = currentFiles.find(f => f.id === fileId);
    if (!file) return;
    
    document.getElementById('file-name').textContent = file.name;
    document.getElementById('detail-workspace').textContent = file.workspace;
    document.getElementById('detail-date').textContent = formatDateTime(file.created_at);
    document.getElementById('detail-size').textContent = formatFileSize(file.size);
    document.getElementById('detail-format').textContent = file.format.toUpperCase();
    document.getElementById('detail-records').textContent = file.record_count || 'N/A';
    
    window.currentFileDetails = file;
    document.getElementById('file-details-modal').style.display = 'block';
}

function hideFileDetailsModal() {
    document.getElementById('file-details-modal').style.display = 'none';
    document.getElementById('preview-section').style.display = 'none';
}

async function downloadFile() {
    if (!window.currentFileDetails) return;
    
    try {
        const response = await fetch('/api/exports/' + window.currentFileDetails.id + '/download');
        if (!response.ok) throw new Error('Download failed');
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = window.currentFileDetails.name;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    } catch (error) {
        console.error('Download error:', error);
        showMessage('Download failed', 'error');
    }
}

async function downloadFileById(fileId) {
    const file = currentFiles.find(f => f.id === fileId);
    if (!file) return;
    
    try {
        const response = await fetch('/api/exports/' + fileId + '/download');
        if (!response.ok) throw new Error('Download failed');
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = file.name;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    } catch (error) {
        console.error('Download error:', error);
        showMessage('Download failed', 'error');
    }
}

async function previewFile() {
    if (!window.currentFileDetails) return;
    
    try {
        const response = await fetch('/api/exports/' + window.currentFileDetails.id + '/preview');
        if (!response.ok) throw new Error('Preview failed');
        
        const data = await response.json();
        const previewContainer = document.getElementById('file-preview');
        
        if (window.currentFileDetails.format === 'json') {
            previewContainer.innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
        } else if (window.currentFileDetails.format === 'csv') {
            const table = document.createElement('table');
            table.className = 'preview-table';
            
            if (data.length > 0) {
                const headerRow = table.insertRow();
                Object.keys(data[0]).forEach(key => {
                    const th = document.createElement('th');
                    th.textContent = key;
                    headerRow.appendChild(th);
                });
                
                data.slice(0, 10).forEach(row => {
                    const tr = table.insertRow();
                    Object.values(row).forEach(value => {
                        const td = tr.insertCell();
                        td.textContent = value;
                    });
                });
                
                if (data.length > 10) {
                    const infoRow = table.insertRow();
                    const td = infoRow.insertCell();
                    td.colSpan = Object.keys(data[0]).length;
                    td.textContent = '... and ' + (data.length - 10) + ' more rows';
                    td.className = 'preview-info';
                }
            }
            previewContainer.appendChild(table);
        }
        
        document.getElementById('preview-section').style.display = 'block';
    } catch (error) {
        console.error('Preview error:', error);
        showMessage('Preview failed', 'error');
    }
}

async function deleteFile() {
    if (!window.currentFileDetails) return;
    
    if (!confirm('Are you sure you want to delete "' + window.currentFileDetails.name + '"?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/exports/' + window.currentFileDetails.id, {
            method: 'DELETE'
        });
        
        if (!response.ok) throw new Error('Delete failed');
        
        showMessage('File deleted successfully', 'success');
        hideFileDetailsModal();
        loadExportedFiles();
    } catch (error) {
        console.error('Delete error:', error);
        showMessage('Delete failed', 'error');
    }
}

async function refreshExportList() {
    await loadExportedFiles();
    showMessage('File list refreshed', 'success');
}



function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString();
}

function formatDateTime(dateString) {
    return new Date(dateString).toLocaleString();
}

function formatFileSize(bytes) {
    if (!bytes) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showMessage(message, type) {
    type = type || 'info';
    const toast = document.createElement('div');
    toast.className = 'toast toast-' + type;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(function() {
        toast.classList.add('show');
    }, 10);
    
    setTimeout(function() {
        toast.classList.remove('show');
        setTimeout(function() {
            if (document.body.contains(toast)) {
                document.body.removeChild(toast);
            }
        }, 300);
    }, 3000);
}
</script>
{% endblock %}