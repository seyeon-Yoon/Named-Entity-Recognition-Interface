{% extends "base.html" %}

{% block content %}
<!-- Hidden login screen for auth.js compatibility -->
<div id="login-screen" style="display: none;"></div>
<!-- Export Files Dashboard -->
<div id="export-dashboard">
    <div class="dashboard-header">
        <h2>Dashboard</h2>
        <div class="dashboard-actions">
            <a href="../collaborate" class="nav-button">ü§ù Collaborate</a>
            <button onclick="refreshExportList()">Refresh</button>
        </div>
    </div>
    
    <div class="workspace-filter">
        <label for="workspace-select">ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§:</label>
        <select id="workspace-select">
            <option value="">Ï†ÑÏ≤¥</option>
        </select>
    </div>
    
    <div id="file-list">
        <ul id="file-items"></ul>
    </div>
</div>

<!-- Export File Details Modal -->
<div id="file-details-modal" class="modal" style="display: none;">
    <div class="modal-content large">
        <div class="modal-header">
            <h3 id="file-name"></h3>
            <button onclick="hideFileDetailsModal()">&times;</button>
        </div>
        <div class="file-details">
            <div class="detail-section">
                <h4>File Information</h4>
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>Workspace:</label>
                        <span id="detail-workspace"></span>
                    </div>
                    <div class="detail-item">
                        <label>Annotator:</label>
                        <span id="detail-annotator"></span>
                    </div>
                    <div class="detail-item">
                        <label>Export Date:</label>
                        <span id="detail-date"></span>
                    </div>
                </div>
            </div>
            <div class="detail-section">
                <h4>Actions</h4>
                <div class="file-actions">
                    <button onclick="viewJsonlFile()" class="btn-primary">View JSONL</button>
                    <button onclick="downloadFile()" class="btn-secondary">Download</button>
                    <button onclick="deleteFile()" class="btn-danger">Delete</button>
                </div>
            </div>
            <div class="detail-section" id="preview-section" style="display: none;">
                <h4>Preview</h4>
                <div id="file-preview" class="file-preview"></div>
            </div>
        </div>
    </div>
</div>
    

<!-- Create Project Modal -->
<div id="create-project-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Create New Project</h3>
        <form id="create-project-form">
            <input type="text" id="new-project-name" placeholder="Project Name" required>
            <textarea id="new-project-description" placeholder="Description (optional)"></textarea>
            <div class="modal-actions">
                <button type="button" onclick="hideCreateProjectModal()">Cancel</button>
                <button type="submit">Create</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadExportedFiles();
    setupFilters();
});

// Export file management
let currentFiles = [];
let filteredFiles = [];


async function loadExportedFiles() {
    try {
        console.log('üì• ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ Î™©Î°ù Î°úÎî© ÏãúÏûë...');
        const response = await fetch('/api/exports');
        console.log('üì° API ÏùëÎãµ ÏÉÅÌÉú:', response.status);
        
        const data = await response.json();
        console.log('üìä Î∞õÏùÄ Îç∞Ïù¥ÌÑ∞:', data);
        
        currentFiles = data.files || [];
        console.log('üìÅ ÌòÑÏû¨ ÌååÏùº Ïàò:', currentFiles.length);
        
        filteredFiles = [...currentFiles];
        updateStats();
        populateWorkspaceFilter();
        renderFileList();
    } catch (error) {
        console.error('‚ùå ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ Î°úÎî© ÏóêÎü¨:', error);
        showMessage('Error loading files', 'error');
    }
}

function updateStats() {
    // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏Îäî Ï†úÍ±∞Îê® (UI ÏöîÏÜå ÏÇ≠Ï†ú)
}

function populateWorkspaceFilter() {
    console.log('üè∑Ô∏è ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ ÌïÑÌÑ∞ ÏÉùÏÑ± Ï§ë...');
    const workspaces = [...new Set(currentFiles.map(file => file.workspace))];
    console.log('üóÇÔ∏è Ï∞æÏùÄ ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§:', workspaces);
    
    const select = document.getElementById('workspace-select');
    select.innerHTML = '<option value="">Ï†ÑÏ≤¥</option>';
    
    workspaces.forEach(workspace => {
        console.log('‚ûï ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ Ï∂îÍ∞Ä:', workspace);
        const option = document.createElement('option');
        option.value = workspace;
        option.textContent = workspace;
        select.appendChild(option);
    });
    
    console.log('‚úÖ ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ ÌïÑÌÑ∞ ÏôÑÎ£å, Ï¥ù', workspaces.length, 'Í∞ú');
}

function setupFilters() {
    document.getElementById('workspace-select').addEventListener('change', applyFilters);
}

function applyFilters() {
    const workspaceFilter = document.getElementById('workspace-select').value;
    
    filteredFiles = currentFiles.filter(file => {
        if (workspaceFilter && file.workspace !== workspaceFilter) return false;
        return true;
    });
    
    updateStats();
    renderFileList();
}

function renderFileList() {
    const container = document.getElementById('file-items');
    
    if (filteredFiles.length === 0) {
        container.innerHTML = '<li class="no-files">ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§</li>';
        return;
    }
    
    container.innerHTML = filteredFiles.map(file => 
        '<li class="file-item" onclick="showFileDetails(\'' + file.id + '\')">' +
            '<span class="file-name">' + file.name + '</span>' +
            '<span class="workspace-tag">' + file.workspace + '</span>' +
        '</li>'
    ).join('');
}

function showFileDetails(fileId) {
    const file = currentFiles.find(f => f.id === fileId);
    if (!file) return;
    
    document.getElementById('file-name').textContent = file.name;
    document.getElementById('detail-workspace').textContent = file.workspace;
    document.getElementById('detail-annotator').textContent = file.annotator || 'unknown_user';
    document.getElementById('detail-date').textContent = formatDateTime(file.created_at);
    
    window.currentFileDetails = file;
    document.getElementById('file-details-modal').style.display = 'block';
}

function hideFileDetailsModal() {
    document.getElementById('file-details-modal').style.display = 'none';
    document.getElementById('preview-section').style.display = 'none';
}

async function downloadFile() {
    if (!window.currentFileDetails) return;
    
    try {
        const response = await fetch('/api/exports/' + window.currentFileDetails.id + '/download');
        if (!response.ok) throw new Error('Download failed');
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = window.currentFileDetails.name;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    } catch (error) {
        console.error('Download error:', error);
        showMessage('Download failed', 'error');
    }
}

async function downloadFileById(fileId) {
    const file = currentFiles.find(f => f.id === fileId);
    if (!file) return;
    
    try {
        const response = await fetch('/api/exports/' + fileId + '/download');
        if (!response.ok) throw new Error('Download failed');
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = file.name;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    } catch (error) {
        console.error('Download error:', error);
        showMessage('Download failed', 'error');
    }
}

async function viewJsonlFile() {
    if (!window.currentFileDetails) return;
    
    try {
        const response = await fetch('/api/exports/' + window.currentFileDetails.id + '/preview');
        if (!response.ok) throw new Error('Failed to load file');
        
        const content = await response.text();
        const previewContainer = document.getElementById('file-preview');
        
        // JSONL ÌååÏùºÏùÑ Ï§ÑÎ≥ÑÎ°ú Î∂ÑÎ¶¨ÌïòÏó¨ Î≥¥Í∏∞ Ï¢ãÍ≤å ÌëúÏãú
        const lines = content.trim().split('\n');
        let formattedContent = '';
        
        lines.forEach((line, index) => {
            if (line.trim()) {
                try {
                    const jsonObj = JSON.parse(line);
                    formattedContent += '<div class="jsonl-line">' +
                        '<div class="line-number">Line ' + (index + 1) + ':</div>' +
                        '<pre>' + JSON.stringify(jsonObj, null, 2) + '</pre>' +
                        '</div>';
                } catch (e) {
                    formattedContent += '<div class="jsonl-line">' +
                        '<div class="line-number">Line ' + (index + 1) + ' (Invalid JSON):</div>' +
                        '<pre>' + line + '</pre>' +
                        '</div>';
                }
            }
        });
        
        previewContainer.innerHTML = formattedContent;
        document.getElementById('preview-section').style.display = 'block';
    } catch (error) {
        console.error('JSONL file load error:', error);
        showMessage('Failed to load file', 'error');
    }
}

async function deleteFile() {
    if (!window.currentFileDetails) return;
    
    if (!confirm('Are you sure you want to delete "' + window.currentFileDetails.name + '"?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/exports/' + window.currentFileDetails.id, {
            method: 'DELETE'
        });
        
        if (!response.ok) throw new Error('Delete failed');
        
        showMessage('File deleted successfully', 'success');
        hideFileDetailsModal();
        loadExportedFiles();
    } catch (error) {
        console.error('Delete error:', error);
        showMessage('Delete failed', 'error');
    }
}

async function refreshExportList() {
    await loadExportedFiles();
    showMessage('File list refreshed', 'success');
}



function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString();
}

function formatDateTime(dateString) {
    return new Date(dateString).toLocaleString();
}

function formatFileSize(bytes) {
    if (!bytes) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showMessage(message, type) {
    type = type || 'info';
    const toast = document.createElement('div');
    toast.className = 'toast toast-' + type;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(function() {
        toast.classList.add('show');
    }, 10);
    
    setTimeout(function() {
        toast.classList.remove('show');
        setTimeout(function() {
            if (document.body.contains(toast)) {
                document.body.removeChild(toast);
            }
        }, 300);
    }, 3000);
}
</script>
{% endblock %}